/* -----------------------------------------------------------
   Digital Sam Media – Core Engine
   Version: 2.0 (Secure & Optimized)
   Hosted on GitHub
------------------------------------------------------------ */

(function() {
    // secure namespace
    const DS_CORE = {
        config: {
            languages: {
                en: "English", hi: "हिन्दी", ar: "Arabic", es: "Spanish", 
                fr: "French", de: "German", it: "Italian", pt: "Portuguese", 
                zh: "Chinese", ru: "Russian"
            },
            defaultLang: "en",
            defaultTZ: Intl.DateTimeFormat().resolvedOptions().timeZone,
            creditUrl: "https://www.digitalsammedia.com/"
        },

        init: function() {
            this.container = document.getElementById("todays-date-widget");
            if (!this.container) return;

            // Security Check: Verify Credit Link Integrity
            this.secureCheck();

            // Load saved settings or defaults
            this.currentLang = localStorage.getItem("ds-lang") || this.config.defaultLang;
            this.currentTZ = localStorage.getItem("ds-tz") || this.config.defaultTZ;

            this.applyTheme();
            this.buildUI();
            this.startTimer();
        },

        secureCheck: function() {
            // "Secure": Ensures the credit link exists and is correct. 
            // If removed, the widget functionality is intentionally degraded or re-inserted.
            const link = this.container.querySelector('.credit-link');
            if (!link || link.getAttribute('href') !== this.config.creditUrl) {
                const newLink = document.createElement('a');
                newLink.className = 'credit-link';
                newLink.href = this.config.creditUrl;
                newLink.target = '_blank';
                newLink.innerText = 'DIGITAL SAM MEDIA';
                newLink.style.display = 'block';
                newLink.style.marginTop = '10px';
                this.container.appendChild(newLink);
            }
        },

        applyTheme: function() {
            const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
            const savedTheme = localStorage.getItem("ds-theme");
            const theme = savedTheme || (prefersDark ? "dark" : "light");
            
            // Apply class to widget container mainly, or body if full page theme
            if(theme === 'dark') {
                this.container.classList.add('ds-dark');
                this.container.classList.remove('ds-light');
            } else {
                this.container.classList.add('ds-light');
                this.container.classList.remove('ds-dark');
            }
        },

        toggleTheme: function() {
            const isDark = DS_CORE.container.classList.contains('ds-dark');
            const newTheme = isDark ? "light" : "dark";
            localStorage.setItem("ds-theme", newTheme);
            DS_CORE.applyTheme();
        },

        buildUI: function() {
            // Create Controls Container
            const controls = document.createElement("div");
            controls.className = "ds-controls";

            // Language Selector
            const langSelect = document.createElement("select");
            langSelect.id = "ds-lang-sel";
            Object.entries(this.config.languages).forEach(([code, name]) => {
                const opt = document.createElement("option");
                opt.value = code;
                opt.text = name;
                if(code === this.currentLang) opt.selected = true;
                langSelect.appendChild(opt);
            });
            langSelect.addEventListener("change", (e) => {
                this.currentLang = e.target.value;
                localStorage.setItem("ds-lang", this.currentLang);
                this.render();
            });

            // Timezone Selector
            const tzSelect = document.createElement("select");
            tzSelect.id = "ds-tz-sel";
            const timezones = Intl.supportedValuesOf("timeZone");
            timezones.forEach(tz => {
                 const opt = document.createElement("option");
                 opt.value = tz;
                 opt.text = tz;
                 if(tz === this.currentTZ) opt.selected = true;
                 tzSelect.appendChild(opt);
            });
            tzSelect.addEventListener("change", (e) => {
                this.currentTZ = e.target.value;
                localStorage.setItem("ds-tz", this.currentTZ);
                this.render();
            });

            // Theme Button
            const themeBtn = document.createElement("button");
            themeBtn.className = "ds-theme-btn";
            themeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>';
            themeBtn.onclick = this.toggleTheme;

            controls.append(langSelect, tzSelect, themeBtn);
            this.container.appendChild(controls);
        },

        render: function() {
            const dateEl = document.getElementById("widget-date");
            const timeEl = document.getElementById("widget-time");
            
            if (!dateEl || !timeEl) return;

            const now = new Date();

            // Date Render
            dateEl.textContent = now.toLocaleDateString(this.currentLang, {
                weekday: "long", year: "numeric", month: "long", day: "numeric", timeZone: this.currentTZ
            });

            // Time Render
            const timeString = now.toLocaleTimeString(this.currentLang, {
                hour: "numeric", minute: "numeric", second: "numeric", hour12: true, timeZone: this.currentTZ
            });
            
            // Formatting time for style
            timeEl.innerHTML = timeString;
        },

        startTimer: function() {
            this.render(); // Instant render
            setInterval(() => this.render(), 1000); // Update every second
            // Periodic integrity check (every 5 seconds)
            setInterval(() => this.secureCheck(), 5000);
        }
    };

    // Initialize when DOM is ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => DS_CORE.init());
    } else {
        DS_CORE.init();
    }
})();
