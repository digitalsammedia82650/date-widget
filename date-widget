/* -----------------------------------------------------------
   Digital Sam Media â€“ Core Engine (Auto-Loader Fixed)
   Hosted on GitHub: https://github.com/digitalsammedia82650/date-widget
   File Name: date-widget.js
------------------------------------------------------------ */

(function() {
    console.log("DSM Widget: Script Loaded from GitHub...");

    const DS_CORE = {
        config: {
            languages: {
                en: "English", hi: "à¤¹à¤¿à¤¨à¥à¤¦à¥€", ar: "Arabic", es: "Spanish", 
                fr: "French", de: "German", it: "Italian", pt: "Portuguese", 
                zh: "Chinese", ru: "Russian"
            },
            defaultLang: "en",
            defaultTZ: Intl.DateTimeFormat().resolvedOptions().timeZone,
            creditUrl: "https://www.digitalsammedia.com/"
        },

        // "Hunter" Logic: Waits for the element to exist before running
        waitForContainer: function() {
            const checkInterval = setInterval(() => {
                const container = document.getElementById("todays-date-widget");
                if (container) {
                    clearInterval(checkInterval);
                    console.log("DSM Widget: Container found! Initializing...");
                    this.init(container);
                }
            }, 50); // Check every 50ms
            
            // Stop checking after 10 seconds to save memory
            setTimeout(() => clearInterval(checkInterval), 10000);
        },

        init: function(container) {
            this.container = container;
            this.secureCheck(); // Security Link Check

            // Load settings
            this.currentLang = localStorage.getItem("ds-lang") || this.config.defaultLang;
            this.currentTZ = localStorage.getItem("ds-tz") || this.config.defaultTZ;

            this.applyTheme();
            this.buildUI(); // Build Dropdowns
            this.startTimer(); // Start Clock
        },

        secureCheck: function() {
            const link = this.container.querySelector('.credit-link');
            // If link is missing or tampered with, force it back
            if (!link || link.getAttribute('href') !== this.config.creditUrl) {
                const newLink = document.createElement('a');
                newLink.className = 'credit-link';
                newLink.href = this.config.creditUrl;
                newLink.target = '_blank';
                newLink.innerText = 'DIGITAL SAM MEDIA';
                this.container.appendChild(newLink);
            }
        },

        applyTheme: function() {
            const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
            const savedTheme = localStorage.getItem("ds-theme");
            const theme = savedTheme || (prefersDark ? "dark" : "light");
            
            if(theme === 'dark') {
                this.container.classList.add('ds-dark');
                this.container.classList.remove('ds-light');
            } else {
                this.container.classList.add('ds-light');
                this.container.classList.remove('ds-dark');
            }
        },

        toggleTheme: function() {
            // Use global window reference to find container if "this" context is lost in event
            const container = document.getElementById("todays-date-widget");
            const isDark = container.classList.contains('ds-dark');
            const newTheme = isDark ? "light" : "dark";
            localStorage.setItem("ds-theme", newTheme);
            
            if(newTheme === 'dark') {
                container.classList.add('ds-dark');
                container.classList.remove('ds-light');
            } else {
                container.classList.add('ds-light');
                container.classList.remove('ds-dark');
            }
        },

        buildUI: function() {
            // Avoid duplicate controls if script runs twice
            if(document.getElementById("ds-controls-box")) return;

            const controls = document.createElement("div");
            controls.id = "ds-controls-box";
            controls.className = "ds-controls";

            // Language
            const langSelect = document.createElement("select");
            Object.entries(this.config.languages).forEach(([code, name]) => {
                const opt = document.createElement("option");
                opt.value = code;
                opt.text = name;
                if(code === this.currentLang) opt.selected = true;
                langSelect.appendChild(opt);
            });
            langSelect.onchange = (e) => {
                this.currentLang = e.target.value;
                localStorage.setItem("ds-lang", this.currentLang);
                this.render();
            };

            // Timezone
            const tzSelect = document.createElement("select");
            const timezones = Intl.supportedValuesOf("timeZone");
            timezones.forEach(tz => {
                 const opt = document.createElement("option");
                 opt.value = tz;
                 opt.text = tz;
                 if(tz === this.currentTZ) opt.selected = true;
                 tzSelect.appendChild(opt);
            });
            tzSelect.onchange = (e) => {
                this.currentTZ = e.target.value;
                localStorage.setItem("ds-tz", this.currentTZ);
                this.render();
            };

            // Theme Button
            const themeBtn = document.createElement("button");
            themeBtn.className = "ds-theme-btn";
            themeBtn.innerHTML = 'ðŸŒ—';
            themeBtn.onclick = this.toggleTheme;

            controls.append(langSelect, tzSelect, themeBtn);
            this.container.appendChild(controls);
        },

        render: function() {
            const dateEl = document.getElementById("widget-date");
            const timeEl = document.getElementById("widget-time");
            
            if (!dateEl || !timeEl) return;

            const now = new Date();

            dateEl.textContent = now.toLocaleDateString(this.currentLang, {
                weekday: "long", year: "numeric", month: "long", day: "numeric", timeZone: this.currentTZ
            });

            // Use innerHTML to allow styling if needed, but simple text is safer
            timeEl.innerText = now.toLocaleTimeString(this.currentLang, {
                hour: "numeric", minute: "numeric", second: "numeric", hour12: true, timeZone: this.currentTZ
            });
        },

        startTimer: function() {
            this.render();
            setInterval(() => this.render(), 1000);
            setInterval(() => this.secureCheck(), 5000); // Check integrity
        }
    };

    // Start the hunter
    DS_CORE.waitForContainer();
})();
