/* date-widget.js
   Digital Sam Media - Widget engine (put this file in your GitHub repo)
   - Renders into an element with id="ds-date-widget"
   - Uses Shadow DOM so CSS is scoped and widget internals are not visible
   - Shows Date + Page Load Time and site credit
*/

(function () {
  'use strict';

  const HUNTER_INTERVAL = 50;   // ms to poll for container
  const HUNTER_TIMEOUT = 10000; // stop hunting after 10s

  function safe(fn) {
    try { fn(); } catch (e) { console.error('DSM Widget error:', e); }
  }

  function computeLoadMs() {
    try {
      // Prefer NavigationTiming Level 2
      const navEntries = (performance.getEntriesByType && performance.getEntriesByType('navigation')) || [];
      const nav = navEntries[0] || null;

      if (nav && typeof nav.loadEventEnd === 'number') {
        if (nav.loadEventEnd > 0) return Math.round(nav.loadEventEnd - (nav.startTime || 0));
        // If loadEventEnd is 0 (not fired) fall back to performance.now()
        return Math.round(performance.now());
      }

      // Legacy timing
      if (performance.timing && performance.timing.navigationStart) {
        const t = performance.timing;
        if (t.loadEventEnd && t.loadEventEnd > 0) {
          return Math.round(t.loadEventEnd - t.navigationStart);
        }
      }

      // Final fallback
      return Math.round(performance.now());
    } catch (e) {
      return null;
    }
  }

  function formatLoad(ms) {
    if (ms === null || ms === undefined || Number.isNaN(ms)) return '—';
    if (ms < 1000) return ms + ' ms';
    return (ms / 1000).toFixed(2) + ' s';
  }

  function formatDate(d) {
    try {
      return d.toLocaleDateString(undefined, {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } catch (e) {
      return d.toDateString();
    }
  }

  function createWidgetInside(container) {
    // Avoid double-init
    if (container.__dsm_widget_inited) return;
    container.__dsm_widget_inited = true;

    // Attach_shadow to avoid CSS leaks and protect credit visibility
    const shadow = container.attachShadow ? container.attachShadow({ mode: 'open' }) : container;

    // styles inside shadow
    const style = document.createElement('style');
    style.textContent = `
      :host { display:inline-block; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
      .dsm-root {
        background: #fff;
        color: #111;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        border-left: 5px solid #2563eb;
        min-width: 220px;
      }
      .dsm-date { font-weight:700; font-size: 0.95rem; margin-bottom:6px; }
      .dsm-load { font-size:1.6rem; font-weight:800; line-height:1; margin-bottom:8px; }
      .dsm-credit { font-size:0.78rem; opacity:0.85; margin-top:8px; }
      .dsm-credit a { color: inherit; text-decoration:none; font-weight:700; }
    `;

    // root markup
    const root = document.createElement('div');
    root.className = 'dsm-root';
    root.innerHTML = `
      <div class="dsm-date" id="dsm-date">Loading date…</div>
      <div class="dsm-load" id="dsm-load">Load: —</div>
      <div class="dsm-credit" id="dsm-credit">
        Widget by <a id="dsm-credit-link" href="https://www.digitalsammedia.com" target="_blank" rel="noopener">www.digitalsammedia.com</a>
      </div>
    `;

    // append
    shadow.appendChild(style);
    shadow.appendChild(root);

    const dateEl = shadow.getElementById ? shadow.getElementById('dsm-date') : root.querySelector('#dsm-date');
    const loadEl = shadow.getElementById ? shadow.getElementById('dsm-load') : root.querySelector('#dsm-load');
    const creditLink = shadow.getElementById ? shadow.getElementById('dsm-credit-link') : root.querySelector('#dsm-credit-link');

    // Render values
    function render() {
      const now = new Date();
      dateEl.textContent = formatDate(now);

      const ms = computeLoadMs();
      loadEl.textContent = 'Load: ' + formatLoad(ms);
    }

    // initial render (use setTimeout to allow loadEventEnd to be set if called right at load)
    setTimeout(render, 50);

    // optional: update clock date once per minute (keeps date accurate across midnight)
    setInterval(() => {
      safe(render);
    }, 60 * 1000);

    // Credit integrity: if someone attempts to remove anchor inside shadow it will re-insert automatically
    setInterval(() => {
      try {
        if (!creditLink || creditLink.getAttribute('href') !== 'https://www.digitalsammedia.com') {
          const parent = root.querySelector('.dsm-credit');
          if (parent) {
            parent.innerHTML = 'Widget by <a id="dsm-credit-link" href="https://www.digitalsammedia.com" target="_blank" rel="noopener">www.digitalsammedia.com</a>';
        }
        }
      } catch (e) { /* ignore */ }
    }, 4000);
  }

  // Hunter: wait for element with id ds-date-widget (max 10s)
  (function hunt() {
    const start = Date.now();
    const interval = setInterval(() => {
      const container = document.getElementById('ds-date-widget');
      if (container) {
        clearInterval(interval);
        safe(() => createWidgetInside(container));
        return;
      }
      if (Date.now() - start > HUNTER_TIMEOUT) {
        clearInterval(interval);
      }
    }, HUNTER_INTERVAL);
  })();

})();
